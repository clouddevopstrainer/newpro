---
- name: ğŸš€ Deploy Monitoring + Application Stack
  hosts: all
  become: yes

  tasks:

    # --- 1ï¸âƒ£ Ensure base directories exist ---
    - name: Ensure /opt/app and /opt/monitoring directories exist
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/app
        - /opt/monitoring

    # --- 2ï¸âƒ£ Update packages and install base dependencies ---
    - name: Wait for apt lock to be released
      shell: |
        while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do
          sleep 5
        done

    - name: Fix apt sources and install Java 17 + Docker
      shell: |
        sudo apt-get update -y
        sudo apt-get install -y openjdk-17-jdk curl apt-transport-https ca-certificates software-properties-common gnupg lsb-release
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
          https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" \
          | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt-get update -y
        sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-compose

    # --- 3ï¸âƒ£ Allow required ports ---
    - name: Allow required ports (8080, 9090, 3000, 9100, 32000)
      shell: |
        sudo ufw allow 8080 || true
        sudo ufw allow 9090 || true
        sudo ufw allow 3000 || true
        sudo ufw allow 9100 || true
        sudo ufw allow 32000/tcp || true
        sudo ufw allow ssh || true
        sudo ufw --force enable || true

    # --- 4ï¸âƒ£ Clean up old containers and networks ---
    - name: Stop and remove old monitoring containers
      shell: |
        docker ps -aq | xargs -r docker stop
        docker ps -aq | xargs -r docker rm

    - name: Remove old Docker networks and volumes
      shell: |
        docker network prune -f
        docker volume prune -f

    # --- 5ï¸âƒ£ Copy Prometheus configuration ---
    - name: Copy Prometheus configuration file
      copy:
        dest: /opt/monitoring/prometheus.yml
        content: |
          global:
            scrape_interval: 15s

          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['prometheus:9090']

            - job_name: 'node_exporter'
              static_configs:
                - targets: ['node-exporter:9100']

            - job_name: 'springboot-app'
              metrics_path: '/actuator/prometheus'
              static_configs:
                - targets: ['localhost:8080']

    # --- 6ï¸âƒ£ Copy Docker Compose file for monitoring stack ---
    - name: Copy Docker Compose for monitoring stack
      copy:
        dest: /opt/monitoring/docker-compose.yml
        content: |
          version: '3.8'

          services:
            prometheus:
              image: prom/prometheus
              container_name: prometheus
              ports:
                - "9090:9090"
              volumes:
                - /opt/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
              restart: always

            grafana:
              image: grafana/grafana
              container_name: grafana
              ports:
                - "3000:3000"
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD=admin
              restart: always

            node-exporter:
              image: prom/node-exporter
              container_name: node_exporter
              ports:
                - "9100:9100"
              restart: always

          networks:
            default:
              driver: bridge

    # --- 7ï¸âƒ£ Start monitoring stack ---
    - name: Start monitoring stack
      shell: |
        cd /opt/monitoring
        docker compose up -d

    # --- 8ï¸âƒ£ Copy application JAR from Jenkins workspace ---
    - name: Copy application JAR dynamically
      copy:
        src: "{{ WORKSPACE }}/target/"
        dest: /opt/app/
        owner: ubuntu
        mode: '0755'
      ignore_errors: no

    # --- 9ï¸âƒ£ Start Spring Boot app ---
    - name: Run Spring Boot application container
      shell: |
        docker stop {{ APP_NAME }} || true
        docker rm {{ APP_NAME }} || true
        docker run -d \
          --name {{ APP_NAME }} \
          -p 8080:8080 \
          -v /opt/app:/app \
          -w /app \
          openjdk:17-jdk-slim java -jar $(ls /opt/app/*.jar | head -n 1)

    # --- ğŸ”Ÿ Install K3s (Lightweight Kubernetes) ---
    - name: Install K3s (Lightweight Kubernetes)
      shell: |
        if ! command -v k3s >/dev/null 2>&1; then
          curl -sfL https://get.k3s.io | sh -
        fi
      args:
        warn: false

    # --- 1ï¸âƒ£1ï¸âƒ£ Ensure Kube config exists ---
    - name: Ensure kube config accessible
      shell: |
        mkdir -p /home/ubuntu/.kube
        cp /etc/rancher/k3s/k3s.yaml /home/ubuntu/.kube/config
        chown -R ubuntu:ubuntu /home/ubuntu/.kube
        chmod 600 /home/ubuntu/.kube/config

    # --- 1ï¸âƒ£2ï¸âƒ£ Deploy ArgoCD if not installed ---
    - name: Deploy ArgoCD in Kubernetes
      shell: |
        export KUBECONFIG=/home/ubuntu/.kube/config
        if ! kubectl get ns argocd >/dev/null 2>&1; then
          kubectl create namespace argocd
          kubectl apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
        fi
        kubectl patch svc argocd-server -n argocd -p '{"spec": {"type": "NodePort", "ports": [{"port": 443, "targetPort": 8080, "nodePort": 32000}]}}' || true

    # --- 1ï¸âƒ£3ï¸âƒ£ Display Access Info ---
    - name: Display Service URLs
      debug:
        msg:
          - "âœ… Application: http://{{ ansible_host }}:8080/api/hello"
          - "ğŸ“Š Prometheus: http://{{ ansible_host }}:9090"
          - "ğŸ“ˆ Grafana: http://{{ ansible_host }}:3000 (admin/admin)"
          - "ğŸš€ ArgoCD: https://{{ ansible_host }}:32000 (admin)"
