# --------------------- START MONITORING STACK ---------------------
- name: ðŸš€ Deploy Prometheus, Grafana, Node Exporter
  hosts: all
  become: yes
  vars:
    monitoring_dir: /opt/monitoring
    containers:
      - monitoring-prometheus
      - monitoring-grafana
      - monitoring-node_exporter
  tasks:

    - name: Ensure /opt/monitoring directory exists
      file:
        path: "{{ monitoring_dir }}"
        state: directory
        mode: '0755'

    - name: Remove old monitoring containers
      community.docker.docker_container:
        name: "{{ item }}"
        state: absent
        force_kill: yes
      loop: "{{ containers }}"

    - name: Clean Docker unused networks and volumes
      community.docker.docker_prune:
        images: no
        containers: no
        networks: yes
        volumes: yes

    - name: Copy Prometheus configuration file
      copy:
        dest: "{{ monitoring_dir }}/prometheus.yml"
        content: |
          global:
            scrape_interval: 15s
          scrape_configs:
            - job_name: 'prometheus'
              static_configs:
                - targets: ['prometheus:9090']
            - job_name: 'node_exporter'
              static_configs:
                - targets: ['node_exporter:9100']

    - name: Copy docker-compose.yml for monitoring stack
      copy:
        dest: "{{ monitoring_dir }}/docker-compose.yml"
        content: |
          version: '3'
          services:
            prometheus:
              image: prom/prometheus
              container_name: monitoring-prometheus
              ports:
                - "9090:9090"
              volumes:
                - ./prometheus.yml:/etc/prometheus/prometheus.yml
              restart: always

            grafana:
              image: grafana/grafana
              container_name: monitoring-grafana
              ports:
                - "3000:3000"
              environment:
                - GF_SECURITY_ADMIN_USER=admin
                - GF_SECURITY_ADMIN_PASSWORD=admin
              restart: always

            node-exporter:
              image: prom/node-exporter
              container_name: monitoring-node_exporter
              ports:
                - "9100:9100"
              volumes:
                - /proc:/host/proc:ro
                - /sys:/host/sys:ro
                - /:/rootfs:ro
              command:
                - '--path.procfs=/host/proc'
                - '--path.sysfs=/host/sys'
                - '--path.rootfs=/rootfs'
              restart: always

    - name: Start monitoring stack with Docker Compose
      community.docker.docker_compose:
        project_src: "{{ monitoring_dir }}"
        state: present
